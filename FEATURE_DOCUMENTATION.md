# InvoiceOCR 项目功能性描述文档

## 📋 项目概述

**InvoiceOCR** 是一个基于视觉语言模型的智能发票识别和分析工具，支持批量处理发票文件，自动提取发票信息，并生成统计报告。项目提供图形界面和命令行两种使用方式，支持跨平台运行（macOS 和 Windows）。

**版本**: 1.0.0  
**主要语言**: Python 3.8+  
**核心技术**: Tkinter GUI、视觉语言模型 API、PDF 处理、Excel 报告生成

---

## 🎯 核心功能

### 1. 多模式发票识别

#### 1.1 快速模式（Simple Mode）
- **功能**: 快速提取发票的价税合计金额
- **特点**:
  - 仅识别发票总金额，速度快
  - 适合大批量发票的快速汇总
  - 自动生成 Markdown 格式的汇总报告
- **实现**: `invoice_ocr_simple.py`
- **输出**: 
  - 控制台实时显示处理进度
  - 生成 `invoice_summary.md` 报告

#### 1.2 完整模式（Full Mode）
- **功能**: 提取发票的完整信息并进行多维度统计分析
- **识别字段**:
  - 发票号码（invoice_no）
  - 开票日期（issue_date）
  - 供应商/卖方名称（seller）
  - 购买方/买方名称（buyer）
  - 价税合计（total）
  - 税额（tax）
  - 小计（subtotal）
  - 商品/服务项目（items）
  - 备注（notes）
- **统计分析**:
  - 按月份统计发票数量和金额
  - 按供应商统计（Top 10）
  - 按金额区间统计（0-1000、1000-10000、10000+）
  - 异常检测（超过平均值 3 倍的发票）
  - 重复发票号检测
- **实现**: `invoice_ocr_sum.py`
- **输出**:
  - Markdown 格式报告（`invoice_summary.md`）
  - Excel 详细报告（`invoice_summary.xlsx`，可选）

---

### 2. 多 API 提供商支持

项目支持多种视觉语言模型 API，用户可根据需求灵活选择：

#### 2.1 Ollama（本地/局域网）
- **特点**: 
  - 支持本地或局域网部署
  - 数据不出内网，安全性高
  - 适合企业内部使用
- **默认配置**:
  - 服务器地址: `192.168.110.219`
  - 端口: `11434`
  - 模型: `qwen3-vl:8b`
- **实现**: `OllamaProvider` 类（ocr_api.py）

#### 2.2 火山引擎（Volcengine）
- **特点**: 
  - 字节跳动提供的视觉模型服务
  - 支持 `doubao-vision-pro` 等模型
  - 云端 API，无需本地部署
- **配置参数**:
  - API Key（必需）
  - Endpoint（可选，默认使用北京区域）
  - Model 名称
- **实现**: `VolcengineProvider` 类（ocr_api.py）

#### 2.3 OpenRouter
- **特点**: 
  - 多模型聚合平台
  - 支持 Google Gemini 等免费模型
  - 默认模型: `google/gemini-2.0-flash-exp:free`
- **配置参数**:
  - API Key（必需）
  - Model 名称
- **实现**: `OpenRouterProvider` 类（ocr_api.py）

---

### 3. 图形界面应用

#### 3.1 界面设计
- **框架**: Tkinter（Python 标准库）
- **布局**: 标签页（Tab）式界面
  - 📋 **处理发票** 标签页
  - ⚙️ **设置** 标签页

#### 3.2 处理发票页面功能
- **目录选择**:
  - 可视化文件浏览器
  - 支持记忆上次选择的目录
- **处理选项**:
  - 模式选择（快速/完整）
  - 生成 Excel 报告（可选）
  - 生成 Markdown 报告（可选）
  - 文件重命名（可选，格式：`金额-购买方名称`）
  - 发票验证（自动跳过非发票文件）
- **实时反馈**:
  - 进度条显示处理进度
  - 滚动日志区域实时显示处理状态
  - 支持停止处理
- **实现**: `InvoiceOCRApp` 类（invoice_ocr_gui.py）

#### 3.3 设置页面功能
- **API 提供商配置**:
  - 下拉选择提供商（Ollama/Volcengine/OpenRouter）
  - 各提供商独立配置区域
- **Ollama 服务器设置**:
  - 服务器地址
  - 端口
  - 模型名称
- **高级设置**:
  - 最大重试次数（0-10）
- **功能按钮**:
  - 💾 保存设置
  - 🔄 恢复默认
  - 🔌 测试连接
- **配置持久化**:
  - 自动保存到 `~/.invoice_ocr_config.json`
  - 应用启动时自动加载

---

### 4. 文件处理能力

#### 4.1 支持的文件格式
- **PDF 文件**: 自动转换首页为 PNG 后识别
- **图片文件**: PNG、JPG、JPEG、WebP、BMP、TIF、TIFF

#### 4.2 PDF 处理机制
- **工具**: `pdftoppm`（poppler 工具包）
- **策略**:
  - 仅处理 PDF 的第一页
  - 转换为 PNG 格式后送入 OCR
  - 使用临时目录存储中间文件
  - 支持长文件名（使用 MD5 哈希避免路径过长）
- **路径查找**:
  - 支持打包应用内的 pdftoppm
  - 自动检测系统路径（Homebrew 等）
- **实现**: `run_pdftoppm_first_page()` 函数

#### 4.3 智能文件过滤
- **自动跳过**:
  - 含有"行程单"关键词的文件
  - 含有"itinerary"关键词的文件
  - 含有"receipt"关键词的文件
- **发票验证**:
  - 可选的发票验证功能
  - 使用视觉模型判断是否为发票
  - 跳过非发票文件，节省处理时间
- **实现**: `iter_invoice_files()` 和 `validate_is_invoice()` 函数

---

### 5. 错误处理与重试机制

#### 5.1 失败重试
- **重试策略**:
  - 默认最大重试次数: 3 次
  - 用户可配置（0-10 次）
  - 识别失败后自动重试
- **重试场景**:
  - 网络错误（HTTP 错误、超时）
  - OCR 识别失败（未识别到金额）
  - PDF 处理失败
- **等待策略**:
  - 普通错误: 等待 2 秒后重试
  - 网络错误: 等待 3 秒后重试
- **实现**: `process_file()` 函数的重试循环

#### 5.2 错误信息记录
- **记录内容**:
  - 错误类型（网络错误、OCR 失败、预处理失败等）
  - 错误详情（仅前 30-40 字符，避免日志过长）
- **状态标记**:
  - ✓ OK: 成功识别
  - ⚠ 警告: 识别到部分信息但不完整
  - ✗ 错误: 处理失败
  - ⊘ 非发票: 文件不是发票

---

### 6. 报告生成功能

#### 6.1 Markdown 报告
- **内容**:
  - 扫描目录
  - 发票数量统计
  - 总金额、平均金额
  - 发票明细表（表格格式）
  - 按月份统计（表格格式）
  - 按供应商统计（Top 10，表格格式）
- **文件名**: `invoice_summary.md`
- **编码**: UTF-8
- **实现**: 主函数中的报告生成逻辑

#### 6.2 Excel 报告
- **依赖**: `openpyxl` 库
- **工作表**:
  1. **发票明细**:
     - 序号、文件名、发票号、开票日期
     - 供应商、购买方
     - 合计金额、税额、小计
     - 项目、状态
  2. **统计汇总**:
     - 发票总数、有效发票数
     - 总金额、平均金额、重复发票号
     - 按月份统计
     - 按供应商统计（Top 10）
- **样式**:
  - 标题行: 蓝色背景、白色加粗字体
  - 边框: 所有单元格
  - 数字格式: 金额保留两位小数
  - 列宽自动调整
- **文件名**: `invoice_summary.xlsx`
- **实现**: `generate_excel_report()` 函数

---

### 7. 文件重命名功能

#### 7.1 命名规则
- **格式**: `{金额}-{购买方名称}.{原扩展名}`
- **示例**: `1234.56-某某公司.pdf`
- **处理**:
  - 购买方名称去除空格
  - 最多保留 15 个字符
  - 金额不保留小数点（整数）

#### 7.2 执行策略
- **可选功能**: 需要用户明确启用
- **安全检查**:
  - 跳过处理失败的发票
  - 跳过缺少金额或购买方信息的发票
  - 如果目标文件已存在，跳过重命名
- **状态反馈**:
  - ✓ 成功重命名
  - ✗ 重命名失败（附带错误信息）
  - → 重命名建议（预览模式）
- **实现**: `rename_invoice_files()` 函数

---

### 8. 配置管理

#### 8.1 配置项
完整的配置数据结构（`AppConfig` 类）:

```python
{
  # API 提供商配置
  "provider": "ollama",  # ollama | volcengine | openrouter
  
  # Ollama 配置
  "ollama_host": "192.168.110.219",
  "ollama_port": 11434,
  "ollama_model": "qwen3-vl:8b",
  
  # 火山引擎配置
  "volcengine_api_key": "",
  "volcengine_endpoint": "",
  "volcengine_model": "doubao-vision-pro",
  
  # OpenRouter 配置
  "openrouter_api_key": "",
  "openrouter_model": "google/gemini-2.0-flash-exp:free",
  
  # 其他配置
  "max_retries": 3,
  "scan_directory": "",
  "mode": "simple",  # simple | full
  "enable_excel": true,
  "enable_markdown": true,
  "enable_rename": false,
  "enable_validate": true
}
```

#### 8.2 配置存储
- **位置**: `~/.invoice_ocr_config.json`
- **格式**: JSON（UTF-8 编码）
- **自动保存**: 点击"保存设置"按钮后立即保存
- **自动加载**: 应用启动时自动加载
- **实现**: `load_config()` 和 `save_config()` 方法

---

### 9. 命令行接口

除了图形界面，项目还提供命令行工具，适合自动化脚本和批处理。

#### 9.1 快速模式命令行
```bash
python3 invoice_ocr_simple.py [目录路径]
```
- **功能**: 快速识别发票金额
- **输出**: 控制台日志 + Markdown 报告

#### 9.2 完整模式命令行
```bash
python3 invoice_ocr_sum.py [目录路径] [选项]
```
- **选项**:
  - `--excel`: 生成 Excel 报告
  - `--rename`: 启用文件重命名
  - `--validate`: 启用非发票验证过滤
  - `--max-retries N`: 设置最大重试次数
- **输出**: 控制台详细日志 + Markdown 报告 + Excel 报告（可选）

---

## 🔧 技术架构

### 核心模块

#### 1. `invoice_ocr_gui.py` - 图形界面主程序
- **类**: `InvoiceOCRApp`
- **职责**:
  - GUI 布局和事件处理
  - 配置管理
  - 后台线程管理
  - 消息队列（线程间通信）
- **线程模型**:
  - 主线程: GUI 事件循环
  - 后台线程: 发票处理任务
  - 消息队列: 后台线程向主线程传递日志和进度

#### 2. `invoice_ocr_sum.py` - 完整模式核心逻辑
- **主要函数**:
  - `iter_invoice_files()`: 扫描发票文件
  - `process_file()`: 处理单个发票（含重试）
  - `validate_and_analyze()`: 数据验证和多维度分析
  - `generate_excel_report()`: 生成 Excel 报告
  - `rename_invoice_files()`: 文件重命名
- **数据类**:
  - `InvoiceInfo`: 发票信息数据结构

#### 3. `invoice_ocr_simple.py` - 快速模式核心逻辑
- **主要函数**:
  - `iter_invoice_files()`: 扫描发票文件
  - `process_file()`: 处理单个发票（仅识别金额）
  - `parse_amount()`: 解析金额（JSON + 正则回退）
- **特点**: 精简、快速、仅关注金额

#### 4. `ocr_api.py` - 统一 OCR API 模块
- **设计模式**: 策略模式
- **基类**: `OCRAPIProvider`
- **实现类**:
  - `OllamaProvider`: Ollama API
  - `VolcengineProvider`: 火山引擎 API
  - `OpenRouterProvider`: OpenRouter API
- **工厂函数**: `create_provider()` - 根据配置创建提供商实例

### 数据流

```
用户输入（GUI/CLI）
    ↓
配置加载
    ↓
文件扫描（iter_invoice_files）
    ↓
PDF 转换（如需要）
    ↓
发票验证（可选）
    ↓
OCR 识别（call_ollama_ocr + Provider）
    ↓
数据解析（parse_invoice_info / parse_amount）
    ↓
重试逻辑（如失败）
    ↓
数据分析（validate_and_analyze）
    ↓
报告生成（Markdown + Excel）
    ↓
文件重命名（可选）
    ↓
结果展示（GUI 日志 / 控制台输出）
```

---

## 📦 打包与分发

### macOS 打包
- **工具**: PyInstaller
- **脚本**: `build_mac.sh`
- **输出**: `dist/InvoiceOCR.app`
- **特点**:
  - 包含 pdftoppm 二进制文件
  - 自动复制 poppler 依赖库
  - 代码签名（ad-hoc）
  - 自动清理扩展属性

### Windows 打包
- **工具**: PyInstaller
- **脚本**: `build_windows.bat`
- **输出**: `dist\InvoiceOCR.exe`
- **特点**:
  - 单文件可执行程序
  - 无需安装 Python 环境

### 打包配置
- **隐藏导入**:
  - `invoice_ocr_sum`
  - `invoice_ocr_simple`
  - `openpyxl`
  - `openpyxl.styles`
- **二进制文件**:
  - `pdftoppm`（macOS）
- **Bundle ID**: `com.invoiceocr.app`

---

## 🚀 使用场景

### 1. 企业财务报销
- **场景**: 批量处理员工提交的报销发票
- **模式**: 完整模式
- **流程**:
  1. 员工上传发票到共享目录
  2. 财务人员使用 InvoiceOCR 批量识别
  3. 生成 Excel 报告，导入财务系统
  4. 按供应商和月份统计，辅助对账

### 2. 快速金额汇总
- **场景**: 月末快速统计发票总金额
- **模式**: 快速模式
- **流程**:
  1. 选择发票目录
  2. 快速识别所有发票金额
  3. 生成 Markdown 报告，查看总金额

### 3. 发票档案管理
- **场景**: 整理和归档历史发票
- **模式**: 完整模式 + 文件重命名
- **流程**:
  1. 扫描旧发票文件
  2. 提取完整信息
  3. 按"金额-购买方"格式重命名
  4. 生成详细报告备查

### 4. 异常发票检测
- **场景**: 审计或风控，检测异常发票
- **模式**: 完整模式 + 发票验证
- **流程**:
  1. 批量处理发票
  2. 自动检测重复发票号
  3. 标记超过平均值 3 倍的大额发票
  4. 生成异常警告列表

---

## ⚠️ 注意事项与限制

### 系统要求
1. **Python 版本**: Python 3.8+
2. **PDF 处理**: 需要安装 poppler（提供 pdftoppm 工具）
   - macOS: `brew install poppler`
   - Windows: 需要下载并配置 PATH
3. **Excel 导出**: 需要安装 `openpyxl` 库（可选）

### 网络要求
1. **Ollama 模式**: 需要能访问 Ollama 服务器
2. **Volcengine/OpenRouter 模式**: 需要公网访问能力

### 性能考虑
1. **处理速度**: 取决于视觉模型的推理速度
   - Ollama 本地: 较快（依赖硬件）
   - 云端 API: 取决于网络延迟和 API 限制
2. **并发处理**: 当前为单线程顺序处理
3. **大文件**: PDF 文件过大可能导致转换失败

### 识别准确性
1. **依赖模型能力**: 识别准确性取决于所用视觉模型
2. **提示词优化**: 已针对发票识别优化提示词
3. **重试机制**: 通过重试提高成功率
4. **人工复核**: 建议对关键发票进行人工复核

### 数据安全
1. **Ollama 模式**: 数据不出内网，安全性最高
2. **云端 API**: 发票图片会上传到第三方服务
3. **配置文件**: API Key 以明文存储在本地（需注意权限）

---

## 📈 未来改进方向

### 功能增强
1. **批量并发处理**: 支持多线程/异步处理，提升速度
2. **更多统计维度**: 增加按项目、按部门等统计
3. **数据导出格式**: 支持 CSV、SQL 等格式
4. **历史记录**: 保存处理历史，支持增量处理

### 界面优化
1. **拖拽支持**: 支持拖拽文件夹到窗口
2. **实时预览**: 显示正在处理的发票预览图
3. **深色模式**: 支持系统深色模式
4. **多语言**: 支持英文等其他语言

### 技术改进
1. **配置加密**: 加密存储 API Key
2. **日志系统**: 完善的日志记录和查询
3. **单元测试**: 增加自动化测试
4. **容错性**: 更强的异常处理和恢复能力

### 模型支持
1. **更多 API**: 支持 Claude、GPT-4V 等
2. **本地模型**: 支持完全离线的本地模型
3. **模型微调**: 针对特定发票格式微调模型

---

## 📝 总结

InvoiceOCR 是一个功能完整、易于使用的发票智能识别工具，具有以下核心优势：

1. **灵活性**: 支持多种 API 提供商，适应不同使用场景
2. **易用性**: 提供图形界面和命令行两种方式
3. **功能性**: 从简单金额提取到完整信息分析，满足不同需求
4. **可靠性**: 完善的错误处理和重试机制
5. **跨平台**: 支持 macOS 和 Windows

项目代码结构清晰，模块化设计良好，便于维护和扩展。适合个人、企业内部使用，也可作为学习视觉语言模型应用的参考项目。
