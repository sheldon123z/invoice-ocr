name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # 当推送 v1.0.0 这样的标签时触发
  workflow_dispatch:  # 允许手动触发

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install system dependencies
        run: |
          brew install poppler tcl-tk

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build macOS application
        run: |
          # 获取 pdftoppm 路径（GitHub Actions 使用 Intel Mac）
          PDFTOPPM_PATH=$(which pdftoppm)
          echo "Found pdftoppm at: $PDFTOPPM_PATH"

          # 直接使用 pyinstaller 打包
          python -m PyInstaller --name=InvoiceOCR --windowed \
            --hidden-import=invoice_ocr_sum \
            --hidden-import=invoice_ocr_simple \
            --hidden-import=ocr_api \
            --hidden-import=openpyxl \
            --hidden-import=openpyxl.styles \
            --add-binary="$PDFTOPPM_PATH:bin" \
            --osx-bundle-identifier=com.invoiceocr.app \
            --noconfirm \
            invoice_ocr_gui.py

          # 签名应用
          if [ -d "dist/InvoiceOCR.app" ]; then
            xattr -cr dist/InvoiceOCR.app 2>/dev/null || true
            codesign --force --deep --sign - dist/InvoiceOCR.app 2>/dev/null || true
          fi

      - name: Create DMG (optional)
        run: |
          # 如果需要创建 DMG 安装包
          # brew install create-dmg
          # create-dmg --volname "Invoice OCR" --window-pos 200 120 --window-size 800 400 InvoiceOCR.dmg dist/InvoiceOCR.app

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v6
        with:
          name: invoice-ocr-macos
          path: dist/InvoiceOCR.app

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install poppler for PDF support
        run: |
          # 下载 poppler for Windows
          $url = "https://github.com/oschwartz10612/poppler-windows/releases/download/v24.08.0-0/Release-24.08.0-0.zip"
          $output = "poppler.zip"
          Invoke-WebRequest -Uri $url -OutFile $output
          Expand-Archive -Path $output -DestinationPath poppler
          # 添加到 PATH
          $popplerBin = "$PWD\poppler\poppler-24.08.0\Library\bin"
          echo "$popplerBin" >> $env:GITHUB_PATH
          echo "Poppler installed at: $popplerBin"
        shell: pwsh

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Windows application
        run: |
          # 获取 poppler bin 路径
          $popplerBin = "$PWD\poppler\poppler-24.08.0\Library\bin"

          # 使用 PyInstaller 打包，包含 poppler（单文件模式）
          python -m PyInstaller --name=InvoiceOCR --windowed --onefile `
            --hidden-import=invoice_ocr_sum `
            --hidden-import=invoice_ocr_simple `
            --hidden-import=ocr_api `
            --hidden-import=openpyxl `
            --hidden-import=openpyxl.styles `
            --add-binary="$popplerBin\pdftoppm.exe;bin" `
            --add-binary="$popplerBin\pdftocairo.exe;bin" `
            --add-binary="$popplerBin\*.dll;bin" `
            --noconfirm `
            invoice_ocr_gui.py

          # 验证生成的文件
          echo "Build output:"
          Get-ChildItem -Path dist -Recurse
        shell: pwsh

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v6
        with:
          name: invoice-ocr-windows
          path: dist/InvoiceOCR.exe

  create-release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download macOS artifact
        uses: actions/download-artifact@v7
        with:
          name: invoice-ocr-macos
          path: ./artifacts/macos

      - name: Download Windows artifact
        uses: actions/download-artifact@v7
        with:
          name: invoice-ocr-windows
          path: ./artifacts/windows

      - name: Create ZIP archives
        run: |
          ROOT_DIR=$(pwd)

          # 检查下载的文件
          echo "Checking macOS artifact:"
          ls -R artifacts/macos/
          echo "Checking Windows artifact:"
          ls -R artifacts/windows/
          
          # 找到 macOS 应用目录（下载的 artifact 会带有一层 artifact 名称目录）
          MAC_APP_PATH=$(find artifacts/macos -maxdepth 3 -type d -name "InvoiceOCR.app" | head -n 1)
          if [ -z "$MAC_APP_PATH" ]; then
            echo "macOS artifact not found (InvoiceOCR.app) under artifacts/macos"
            exit 1
          fi
          MAC_APP_DIR=$(dirname "$MAC_APP_PATH")
          cd "$MAC_APP_DIR"
          zip -r "$ROOT_DIR/InvoiceOCR-macOS.zip" "$(basename "$MAC_APP_PATH")"
          cd "$ROOT_DIR"
          
          # 找到 Windows 可执行文件
          WIN_EXE_PATH=$(find artifacts/windows -maxdepth 3 -type f -name "InvoiceOCR.exe" | head -n 1)
          if [ -z "$WIN_EXE_PATH" ]; then
            echo "Windows artifact not found (InvoiceOCR.exe) under artifacts/windows"
            exit 1
          fi
          WIN_EXE_DIR=$(dirname "$WIN_EXE_PATH")
          cd "$WIN_EXE_DIR"
          zip -r "$ROOT_DIR/InvoiceOCR-Windows.zip" "$(basename "$WIN_EXE_PATH")"
          cd "$ROOT_DIR"

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            InvoiceOCR-macOS.zip
            InvoiceOCR-Windows.zip
          body: |
            ## Invoice OCR GUI Application - ${{ steps.get_version.outputs.VERSION }}

            ### Features
            - 发票 OCR 识别 GUI 应用程序
            - 支持批量处理发票图片
            - 自动提取发票信息并导出到 Excel
            - 跨平台支持 (macOS & Windows)

            ### 下载
            - **macOS**: 下载 `InvoiceOCR-macOS.zip`，解压后运行 `InvoiceOCR.app`
            - **Windows**: 下载 `InvoiceOCR-Windows.zip`，解压后运行 `InvoiceOCR.exe`

            ### 从源码安装
            ```bash
            git clone https://github.com/${{ github.repository }}.git
            cd invoice-ocr
            pip install -r requirements.txt
            python invoice_ocr_gui.py
            ```

            ### 更新日志
            请查看完整的更新内容
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
